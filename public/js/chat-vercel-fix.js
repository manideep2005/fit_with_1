// Vercel Chat System Fix
// This script ensures chat functionality works properly in Vercel's serverless environment

console.log('ðŸ”§ Loading Vercel Chat Fix...');

// Enhanced chat initialization for Vercel
class VercelChatFix {
    constructor() {
        this.isVercelEnvironment = this.detectVercelEnvironment();
        this.retryCount = 0;
        this.maxRetries = 3;
        
        this.init();
    }
    
    detectVercelEnvironment() {
        return !!(
            window.location.hostname.includes('vercel.app') ||
            window.location.hostname.includes('vercel.com') ||
            document.querySelector('meta[name=\"vercel-deployment-url\"]') ||
            window.VERCEL_ENV
        );
    }
    
    init() {
        console.log('ðŸš€ Initializing Vercel Chat Fix...');
        console.log('ðŸ“ Environment:', this.isVercelEnvironment ? 'Vercel' : 'Local');
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.setupChat());
        } else {
            this.setupChat();
        }
    }
    
    setupChat() {
        // Check if we're on the chat page
        const chatContainer = document.querySelector('.chat-container');
        if (!chatContainer) {
            console.log('ðŸ“ Not on chat page, skipping chat setup');
            return;
        }
        
        console.log('ðŸ’¬ Setting up chat for Vercel environment...');
        
        // Ensure advanced chat is loaded
        this.ensureAdvancedChatLoaded();
        
        // Setup fallback message sending
        this.setupFallbackMessageSending();
        
        // Setup periodic friend list refresh
        this.setupPeriodicRefresh();
        
        // Setup connection status monitoring
        this.setupConnectionMonitoring();
    }
    
    ensureAdvancedChatLoaded() {\n        let attempts = 0;\n        const maxAttempts = 10;\n        \n        const checkAdvancedChat = () => {\n            attempts++;\n            \n            if (window.advancedChat || window.AdvancedChatSystem) {\n                console.log('âœ… Advanced chat system loaded');\n                return;\n            }\n            \n            if (attempts < maxAttempts) {\n                console.log(`â³ Waiting for advanced chat... (${attempts}/${maxAttempts})`);\n                setTimeout(checkAdvancedChat, 500);\n            } else {\n                console.log('âš ï¸ Advanced chat not loaded, initializing fallback');\n                this.initializeFallbackChat();\n            }\n        };\n        \n        checkAdvancedChat();\n    }\n    \n    initializeFallbackChat() {\n        console.log('ðŸ”„ Initializing fallback chat system...');\n        \n        // Basic chat functionality for when advanced chat fails to load\n        window.fallbackChat = {\n            currentFriend: null,\n            \n            selectFriend: (friendId, friendName) => {\n                console.log('ðŸ‘¥ Selecting friend (fallback):', friendId, friendName);\n                \n                this.currentFriend = friendId;\n                \n                // Update UI\n                const chatTitle = document.getElementById('chatTitle');\n                const messageInput = document.getElementById('messageInput');\n                const sendBtn = document.getElementById('sendBtn');\n                const chatOptions = document.getElementById('chatOptions');\n                \n                if (chatTitle) chatTitle.textContent = friendName;\n                if (messageInput) messageInput.disabled = false;\n                if (sendBtn) sendBtn.disabled = false;\n                if (chatOptions) chatOptions.style.display = 'block';\n                \n                // Load messages\n                this.loadMessages(friendId);\n            },\n            \n            sendMessage: async () => {\n                const messageInput = document.getElementById('messageInput');\n                const content = messageInput.value.trim();\n                \n                if (!content || !this.currentFriend) return;\n                \n                try {\n                    const response = await fetch('/api/chat/send', {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify({\n                            receiverId: this.currentFriend,\n                            content: content\n                        })\n                    });\n                    \n                    const result = await response.json();\n                    \n                    if (result.success) {\n                        messageInput.value = '';\n                        this.loadMessages(this.currentFriend);\n                        this.showToast('Message sent!', 'success');\n                    } else {\n                        this.showToast('Failed to send message', 'error');\n                    }\n                } catch (error) {\n                    console.error('Send message error:', error);\n                    this.showToast('Error sending message', 'error');\n                }\n            }\n        };\n        \n        // Bind fallback functions to global scope\n        window.selectFriend = window.fallbackChat.selectFriend;\n        window.sendMessage = window.fallbackChat.sendMessage;\n    }\n    \n    async loadMessages(friendId) {\n        try {\n            const response = await fetch(`/api/chat/messages/${friendId}`);\n            const data = await response.json();\n            \n            if (data.success && data.messages) {\n                this.displayMessages(data.messages);\n            } else {\n                document.getElementById('messagesArea').innerHTML = \n                    '<div class=\"empty-chat\"><p>Start your conversation!</p></div>';\n            }\n        } catch (error) {\n            console.error('Load messages error:', error);\n        }\n    }\n    \n    displayMessages(messages) {\n        const messagesArea = document.getElementById('messagesArea');\n        if (!messagesArea) return;\n        \n        const messagesHtml = messages.map(message => {\n            const isSender = message.sender._id === window.currentUserId;\n            const time = new Date(message.createdAt).toLocaleTimeString('en-US', { \n                hour: '2-digit', \n                minute: '2-digit' \n            });\n            \n            return `\n                <div class=\"message ${isSender ? 'sent' : 'received'}\">\n                    <div class=\"message-content\">${this.escapeHtml(message.content)}</div>\n                    <div class=\"message-meta\">\n                        <span class=\"message-time\">${time}</span>\n                    </div>\n                </div>\n            `;\n        }).join('');\n        \n        messagesArea.innerHTML = messagesHtml;\n        messagesArea.scrollTop = messagesArea.scrollHeight;\n    }\n    \n    setupFallbackMessageSending() {\n        // Ensure message sending works even if advanced chat fails\n        const sendBtn = document.getElementById('sendBtn');\n        const messageInput = document.getElementById('messageInput');\n        \n        if (sendBtn && messageInput) {\n            // Remove existing listeners and add our own\n            sendBtn.onclick = null;\n            sendBtn.addEventListener('click', () => {\n                if (window.advancedChat && window.advancedChat.sendMessage) {\n                    window.advancedChat.sendMessage();\n                } else if (window.fallbackChat && window.fallbackChat.sendMessage) {\n                    window.fallbackChat.sendMessage();\n                } else {\n                    console.log('âš ï¸ No chat system available for sending messages');\n                }\n            });\n            \n            messageInput.addEventListener('keypress', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    sendBtn.click();\n                }\n            });\n        }\n    }\n    \n    setupPeriodicRefresh() {\n        // Refresh friends list and conversations periodically\n        setInterval(async () => {\n            try {\n                // Refresh unread count\n                const response = await fetch('/api/chat/unread-count');\n                const data = await response.json();\n                \n                if (data.success) {\n                    const badge = document.getElementById('unreadBadge');\n                    if (badge) {\n                        if (data.unreadCount > 0) {\n                            badge.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;\n                            badge.style.display = 'inline-block';\n                        } else {\n                            badge.style.display = 'none';\n                        }\n                    }\n                }\n            } catch (error) {\n                console.log('Periodic refresh error (ignored):', error.message);\n            }\n        }, 30000); // Every 30 seconds\n    }\n    \n    setupConnectionMonitoring() {\n        // Monitor connection status\n        let isOnline = navigator.onLine;\n        \n        const updateConnectionStatus = (online) => {\n            const statusIndicator = document.getElementById('connectionStatus');\n            if (statusIndicator) {\n                statusIndicator.textContent = online ? 'Online' : 'Offline';\n                statusIndicator.className = `connection-status ${online ? 'online' : 'offline'}`;\n            }\n            \n            if (online && !isOnline) {\n                // Just came back online, refresh data\n                this.refreshChatData();\n            }\n            \n            isOnline = online;\n        };\n        \n        window.addEventListener('online', () => updateConnectionStatus(true));\n        window.addEventListener('offline', () => updateConnectionStatus(false));\n        \n        // Initial status\n        updateConnectionStatus(navigator.onLine);\n    }\n    \n    async refreshChatData() {\n        console.log('ðŸ”„ Refreshing chat data after reconnection...');\n        \n        try {\n            // Reload friends if function exists\n            if (typeof loadFriends === 'function') {\n                await loadFriends();\n            }\n            \n            // Reload current conversation if one is selected\n            if (window.currentFriend || (window.advancedChat && window.advancedChat.currentFriend)) {\n                const friendId = window.currentFriend || window.advancedChat.currentFriend;\n                await this.loadMessages(friendId);\n            }\n            \n            this.showToast('Chat data refreshed', 'info');\n        } catch (error) {\n            console.error('Error refreshing chat data:', error);\n        }\n    }\n    \n    escapeHtml(text) {\n        const div = document.createElement('div');\n        div.textContent = text;\n        return div.innerHTML;\n    }\n    \n    showToast(message, type = 'info') {\n        const toast = document.createElement('div');\n        toast.className = `toast-notification toast-${type}`;\n        toast.textContent = message;\n        \n        toast.style.cssText = `\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            padding: 12px 20px;\n            border-radius: 8px;\n            color: white;\n            font-weight: 500;\n            z-index: 10000;\n            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};\n            box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n            transform: translateX(400px);\n            transition: transform 0.3s ease;\n        `;\n        \n        document.body.appendChild(toast);\n        \n        // Animate in\n        setTimeout(() => {\n            toast.style.transform = 'translateX(0)';\n        }, 100);\n        \n        // Remove after 3 seconds\n        setTimeout(() => {\n            toast.style.transform = 'translateX(400px)';\n            setTimeout(() => {\n                if (toast.parentNode) {\n                    toast.parentNode.removeChild(toast);\n                }\n            }, 300);\n        }, 3000);\n    }\n}\n\n// Initialize the Vercel chat fix\nconst vercelChatFix = new VercelChatFix();\nwindow.vercelChatFix = vercelChatFix;\n\nconsole.log('âœ… Vercel Chat Fix loaded successfully');
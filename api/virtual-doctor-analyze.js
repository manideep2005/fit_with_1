const fs = require('fs');\nconst path = require('path');\n\n// Load medical conditions database\nlet medicalDatabase = {};\ntry {\n    const dbPath = path.join(__dirname, '..', 'public', 'data', 'medical-conditions.json');\n    medicalDatabase = JSON.parse(fs.readFileSync(dbPath, 'utf8'));\n    console.log('Medical database loaded:', Object.keys(medicalDatabase).length, 'conditions');\n} catch (error) {\n    console.error('Failed to load medical database:', error);\n}\n\n// Advanced symptom matching with intelligent scoring\nfunction findMatchingConditions(symptoms) {\n    const matches = [];\n    const symptomWords = symptoms.toLowerCase()\n        .replace(/[^a-z\\s]/g, ' ')\n        .split(/\\s+/)\n        .filter(word => word.length > 2);\n    \n    for (const [conditionKey, condition] of Object.entries(medicalDatabase)) {\n        let matchScore = 0;\n        let matchedSymptoms = new Set();\n        \n        // Direct symptom matching (highest weight)\n        for (const symptom of condition.symptoms) {\n            const symptomLower = symptom.toLowerCase();\n            for (const word of symptomWords) {\n                if (symptomLower.includes(word) || word.includes(symptomLower.substring(0, Math.min(4, symptomLower.length)))) {\n                    matchScore += 3;\n                    matchedSymptoms.add(symptom);\n                    break;\n                }\n            }\n        }\n        \n        // Condition name matching (medium weight)\n        const conditionName = condition.name.toLowerCase();\n        for (const word of symptomWords) {\n            if (conditionName.includes(word) || word.includes(conditionName.substring(0, Math.min(4, conditionName.length)))) {\n                matchScore += 2;\n            }\n        }\n        \n        // Description matching (lower weight)\n        const description = condition.description.toLowerCase();\n        for (const word of symptomWords) {\n            if (description.includes(word)) {\n                matchScore += 1;\n            }\n        }\n        \n        // Home remedies and medication matching (context clues)\n        const allText = [...condition.homeRemedies, ...condition.medications].join(' ').toLowerCase();\n        for (const word of symptomWords) {\n            if (allText.includes(word)) {\n                matchScore += 0.5;\n            }\n        }\n        \n        if (matchScore > 0) {\n            const confidence = Math.min(matchScore / 10, 1); // Normalize to 0-1\n            matches.push({\n                condition,\n                confidence,\n                matchScore,\n                matchedSymptoms: Array.from(matchedSymptoms)\n            });\n        }\n    }\n    \n    // Sort by confidence and return top matches\n    return matches\n        .sort((a, b) => b.confidence - a.confidence)\n        .slice(0, 6);\n}\n\n// Generate comprehensive AI analysis\nfunction generateAIAnalysis(symptoms, matches) {\n    if (matches.length === 0) {\n        return `I couldn't find specific matching conditions for \"${symptoms}\" in my medical database. This could indicate a rare condition or the symptoms might need to be described differently. I recommend consulting a healthcare professional for proper evaluation.`;\n    }\n    \n    const topMatch = matches[0];\n    const confidence = Math.round(topMatch.confidence * 100);\n    \n    let analysis = `<strong>AI Analysis for \"${symptoms}\":</strong><br><br>`;\n    \n    // Primary assessment\n    analysis += `The most likely condition based on symptom analysis is <strong>${topMatch.condition.name}</strong> with ${confidence}% confidence. `;\n    \n    if (topMatch.matchedSymptoms.length > 0) {\n        analysis += `Matching symptoms include: ${topMatch.matchedSymptoms.join(', ')}.<br><br>`;\n    }\n    \n    // Additional possibilities\n    if (matches.length > 1) {\n        const otherConditions = matches.slice(1, 4).map(m => {\n            const conf = Math.round(m.confidence * 100);\n            return `${m.condition.name} (${conf}%)`;\n        });\n        analysis += `<strong>Other possibilities:</strong> ${otherConditions.join(', ')}.<br><br>`;\n    }\n    \n    // General recommendations\n    analysis += `<strong>Recommendations:</strong><br>`;\n    analysis += `• Review the detailed condition information below<br>`;\n    analysis += `• Consider the recommended foods and home remedies<br>`;\n    analysis += `• Monitor symptom progression<br>`;\n    analysis += `• Consult a healthcare professional for proper diagnosis<br><br>`;\n    \n    // Urgency assessment\n    const urgentKeywords = ['severe', 'emergency', 'immediate', 'urgent', 'blood', 'difficulty breathing'];\n    const hasUrgentSymptoms = topMatch.condition.whenToSeeDoctor.toLowerCase().split(' ').some(word => \n        urgentKeywords.some(urgent => word.includes(urgent))\n    );\n    \n    if (hasUrgentSymptoms) {\n        analysis += `<strong style=\"color: #ff6b6b;\">⚠️ IMPORTANT:</strong> Based on the condition analysis, some symptoms may require immediate medical attention. Please review the \"When to See a Doctor\" section carefully.`;\n    }\n    \n    return analysis;\n}\n\n// Intelligent symptom combination analysis\nfunction analyzeSymptomCombinations(symptoms, matches) {\n    const combinations = [];\n    \n    // Look for common symptom patterns\n    const symptomPatterns = {\n        'respiratory': ['cough', 'breathing', 'throat', 'chest', 'lungs'],\n        'digestive': ['stomach', 'nausea', 'vomiting', 'diarrhea', 'constipation'],\n        'neurological': ['headache', 'dizziness', 'fatigue', 'confusion'],\n        'inflammatory': ['fever', 'swelling', 'pain', 'redness']\n    };\n    \n    const symptomWords = symptoms.toLowerCase().split(/\\s+/);\n    \n    for (const [category, keywords] of Object.entries(symptomPatterns)) {\n        const matchCount = keywords.filter(keyword => \n            symptomWords.some(word => word.includes(keyword) || keyword.includes(word))\n        ).length;\n        \n        if (matchCount >= 2) {\n            combinations.push({\n                category,\n                strength: matchCount / keywords.length,\n                keywords: keywords.filter(keyword => \n                    symptomWords.some(word => word.includes(keyword) || keyword.includes(word))\n                )\n            });\n        }\n    }\n    \n    return combinations;\n}\n\nmodule.exports = async (req, res) => {\n    try {\n        console.log('Virtual doctor analyze called with body:', req.body);
        console.log('Medical database loaded conditions:', Object.keys(medicalDatabase).length);
        
        const { symptoms } = req.body;\n        \n        if (!symptoms || typeof symptoms !== 'string') {\n            return res.status(400).json({\n                success: false,\n                error: 'Please provide symptoms as a string'\n            });\n        }\n        \n        if (symptoms.length < 3) {\n            return res.status(400).json({\n                success: false,\n                error: 'Please provide more detailed symptom description'\n            });\n        }\n        \n        // Check if database is loaded
        if (Object.keys(medicalDatabase).length === 0) {
            console.error('Medical database is empty or failed to load');
            return res.status(500).json({
                success: false,
                error: 'Medical database is not available. Please try again later.'
            });
        }
        
        // Find matching conditions with advanced scoring
        const matches = findMatchingConditions(symptoms);
        console.log('Found matches:', matches.length);\n        \n        // Analyze symptom combinations\n        const combinations = analyzeSymptomCombinations(symptoms, matches);\n        \n        // Generate comprehensive AI analysis\n        const aiAnalysis = generateAIAnalysis(symptoms, matches);\n        \n        res.json({\n            success: true,\n            matches,\n            aiAnalysis,\n            combinations,\n            query: symptoms,\n            totalConditions: Object.keys(medicalDatabase).length,\n            analysisTimestamp: new Date().toISOString()\n        });\n        \n    } catch (error) {\n        console.error('Virtual doctor analysis error:', error);\n        res.status(500).json({\n            success: false,\n            error: 'Internal server error during analysis. Please try again.'\n        });\n    }\n};